name: 构建 Recovery

on:
  workflow_dispatch:
    inputs:
      MANIFEST_URL:
        description: 'MANIFEST_URL'
        required: true
        default: ''
      MANIFEST_BRANCH:
        description: 'MANIFEST_BRANCH'
        required: true
        default: 'twrp-12.1'
      DEVICE_TREE_URL:
        description: 'DEVICE_TREE_URL'
        required: true
        default: ''
      DEVICE_TREE_BRANCH:
        description: 'DEVICE_TREE_BRANCH'
        required: true
        default: ''
      DEVICE_PATH:
        description: 'DEVICE_PATH'
        required: true
        default: ''
      COMMON_TREE_URL:
        description: 'COMMON_TREE_URL'
        required: false
      COMMON_PATH:
        description: 'COMMON_PATH'
        required: false
      DEVICE_NAME:
        description: 'DEVICE_NAME'
        required: true
        default: 'rk3588s_su30pro_native'
      MAKEFILE_NAME:
        description: 'MAKEFILE_NAME'
        required: true
        default: 'twrp_su30pro'
      BUILD_TARGET:
        description: 'BUILD_TARGET'
        required: true
        default: 'recovery'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Create Dockerfile
      run: |
        cat > Dockerfile.twrp << 'EOF'
        FROM ubuntu:20.04

        ENV DEBIAN_FRONTEND=noninteractive

        RUN apt update && apt -y upgrade && \
            apt -y install \
            gperf gcc-multilib gcc-10-multilib g++-multilib g++-10-multilib \
            libc6-dev lib32ncurses5-dev x11proto-core-dev libx11-dev tree \
            lib32z-dev libgl1-mesa-dev libxml2-utils xsltproc bc ccache \
            lib32readline-dev lib32z1-dev liblz4-tool libncurses5-dev \
            libsdl1.2-dev libwxgtk3.0-gtk3-dev libxml2 lzop pngcrush \
            schedtool squashfs-tools imagemagick libbz2-dev lzma ncftp \
            qemu-user-static libstdc++-10-dev libncurses5 python curl git unzip zip openjdk-8-jdk

        RUN mkdir /root/bin && \
            curl https://storage.googleapis.com/git-repo-downloads/repo > /root/bin/repo && \
            chmod a+x /root/bin/repo && \
            ln -sf /root/bin/repo /usr/bin/repo

        WORKDIR /workspace
        EOF

    - name: Build Docker Image
      run: docker build -t twrp-builder -f Dockerfile.twrp .

    - name: Run Build in Docker
      run: |
        docker run --rm \
          -v ${{ github.workspace }}:/workspace \
          -e MANIFEST_URL="${{ github.event.inputs.MANIFEST_URL }}" \
          -e MANIFEST_BRANCH="${{ github.event.inputs.MANIFEST_BRANCH }}" \
          -e DEVICE_TREE_URL="${{ github.event.inputs.DEVICE_TREE_URL }}" \
          -e DEVICE_TREE_BRANCH="${{ github.event.inputs.DEVICE_TREE_BRANCH }}" \
          -e DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}" \
          -e COMMON_TREE_URL="${{ github.event.inputs.COMMON_TREE_URL }}" \
          -e COMMON_PATH="${{ github.event.inputs.COMMON_PATH }}" \
          -e DEVICE_NAME="${{ github.event.inputs.DEVICE_NAME }}" \
          -e MAKEFILE_NAME="${{ github.event.inputs.MAKEFILE_NAME }}" \
          -e BUILD_TARGET="${{ github.event.inputs.BUILD_TARGET }}" \
          twrp-builder \
          bash -c "
            git config --global user.name 'builder'
            git config --global user.email 'builder@example.com'

            mkdir workspace
            cd workspace

            repo init --depth=1 -u \$MANIFEST_URL -b \$MANIFEST_BRANCH
            repo sync -j\$(nproc --all) --force-sync

            git clone $DEVICE_TREE_URL -b $DEVICE_TREE_BRANCH $DEVICE_PATH

            if [ ! -z \"\$COMMON_TREE_URL\" ]; then
              git clone \$COMMON_TREE_URL -b \$DEVICE_TREE_BRANCH ./\$COMMON_PATH
            fi

            source build/envsetup.sh
            export ALLOW_MISSING_DEPENDENCIES=true
            lunch \$MAKEFILE_NAME-eng
            make clean
            make \$BUILD_TARGETimage -j\$(nproc --all)
          "

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: workspace/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
        name: ${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: |
          Manifest: ${{ github.event.inputs.MANIFEST_BRANCH }}
          Device: ${{ github.event.inputs.DEVICE_NAME }}
          Target: ${{ github.event.inputs.BUILD_TARGET }}.img
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
